[toc]

很遗憾，工作快4年了，却从来没有处理过规模大到需要分库分表的数据。所以专门网上找文章学习一下。



# 为什么需要分库分表

关系数据库，当单表数据量达到千万级别，效率便会明显变低。

但是分表不能提升数据库的单点并发量，所以可以分库。

分库分表从原理上来说，差不多，后面讨论时不做详细区分。

# 怎么分库分表

按照某个关键字段进行哈希映射。比如分两个库，那么可以取余为0的分到库1，取余为1的分到库2。

比如用户表可以使用用户id进行划分

# 分库分表之后怎么平滑扩容

由于业务总是在发展之中，不可能一开始就准备过大规模。

那么当业务发展到一定阶段，数据库不够用时，需要扩容，要扩容，扩容之后，映射关系发生改变，肯定就涉及到把已有的部分用户迁移到不同的库，那么怎么才能保证平滑扩容呢？

[分库分表平滑扩容](https://www.cnblogs.com/barrywxx/p/11532122.html)

[亿级数据DB如何实现秒级平滑扩容](https://zhuanlan.zhihu.com/p/109711210)

## 是否能够将用户ID设计成递增的

那么就可以用户id为0-500万的用户在一个表。继续新增用户，就新增一个表，用来存500万-1000万的用户。

这样就完全做到了水平扩展，对已有用户毫无影响。看网上介绍的文章貌似都没提到这个思路，这个思路有问题？

# 分库之后，怎么按其他字段查询
比如按用户ID分库之后，怎么按用户手机号查询？

[百亿级数据分表后怎么分页查询？](https://segmentfault.com/a/1190000037776663)

[userId分库，怎么通过其他字段查询](https://blog.csdn.net/Melod_bc/article/details/70225250)

简单总结：
1. 需要按哪个字段来查，就建立一个对应字段到分库的字段的映射关系。当然如果规模过大，这个映射关系也需要分库分表。多了一次查询，对响应速度有影响。
2. 数据存多份，比如根据用户ID分库存一份，根据手机号分库存一份。这样对查询速度没影响，但是需要更多存储资源，修改数据时需要修改多个地方，维护数据一致性难度变大了。
3. 对于某些生成的字段，比如订单号，可以在生成订单号时，将用户ID放到前面。这样按用户ID分库的，也可以用订单号查询。
4. 对于不经常查询的数据，可以使用elastic search来查询，其可以轻松支持这个量级的数据。（ES这么厉害？）

# 怎么保证分库ID全局唯一性
如果没有分库分表，可以使用数据库自增ID作为用户ID。分库之后，需要在访问数据库之前生成ID，并根据ID决定访问哪个库。可以使用雪花算法来生成唯一ID。
[分库分表之后，id 主键如何处理？](https://zhuanlan.zhihu.com/p/54838983)
## 怎么防止用户重复注册？
在同一个库中，可以使用数据库唯一性约束来保证。分库之后怎么保证？
也许是这样：
如果每个手机号可以注册一个用户，那么必须得有一份从手机到用户的映射数据，用户注册时，先去查询手机号是否已经注册。
